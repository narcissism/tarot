<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tarot Reader</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: #111;
  color: #eee;
  font-family: serif;
  display: flex;
}

#controls {
  width: 240px;
  padding: 20px;
  background: #222;
  border-right: 1px solid #444;
}

#controls input {
  width: 100%;
  padding: 6px;
  margin-bottom: 12px;
  border-radius: 4px;
  border: 1px solid #555;
  background: #222;
  color: #eee;
}

button {
  width: 100%;
  margin-bottom: 12px;
  padding: 10px;
  background: #333;
  color: #eee;
  border: 1px solid #555;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background: #444; }

#fan-container {
  flex: 1;
  position: relative;
  overflow: hidden;
}

/* Meaning panel */
#meaning-panel {
  position: absolute;
  bottom: 20px;
  left: 20px;
  width: 260px;
  padding: 14px;
  background: rgba(0,0,0,0.75);
  border: 1px solid #444;
  border-radius: 8px;
  font-size: 14px;
  display: none;
}

/* Card styles */
.card {
  position: absolute;
  width: 140px;
  height: 220px;
  perspective: 1000px;
  cursor: pointer;
}

.card-inner {
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  transition: transform 0.7s ease;
  position: relative;
}

.card.flipped .card-inner {
  transform: rotateY(180deg);
}

.face {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  background-size: cover;
  background-position: center;
  border-radius: 10px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.7);
}

.front { transform: rotateY(180deg); }
</style>
</head>

<body>

<div id="controls">
  <input type="text" id="userQuestion" placeholder="Enter your question or wish">
  <button onclick="deal('single')">Single Card</button>
  <button onclick="deal('three')">Past · Present · Future</button>
  <button onclick="deal('celtic')">Celtic Cross</button>
  <button onclick="clarify()">Clarify</button>
  <button onclick="reshuffle()">Reshuffle</button>
</div>

<div id="fan-container">
  <div id="meaning-panel">Card meanings will appear here.</div>
</div>

<script>
const container = document.getElementById("fan-container");
const meaningPanel = document.getElementById("meaning-panel");

let workingDeck = [];
let currentSpread = null;
let clarifyIndex = 0;
let topZ = 100;
let leftEdge = 0;
let cardMeanings = {};

// ===== Load card meanings JSON =====
fetch("cardMeanings.json")
  .then(res => res.json())
  .then(data => cardMeanings = data)
  .catch(e => console.error("Error loading card meanings:", e));

// ===== Placement notes =====
const placementNotes = {
  single: { 0: "" },
  three: {
    0: "Past",
    1: "Present",
    2: "Future"
  },
  celtic: {
    0: "You: your current position",
    1: "What covers/crosses you: obstacles or supports.",
    2: "Crux of situation.",
    3: "Past: conditions behind you.",
    4: "What crowns you: your goal to keep in sight.",
    5: "Short-term future events that will soon come to pass.",
    6: "Your personality: how to conduct yourself for desired outcome.",
    7: "How others see you",
    8: "Your hopes and fears",
    9: "The final outcome"
  }
};

// ===== Shuffle =====
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length-1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// ===== Spreads =====
const spreads = {
  single: [{ x: 420, y: 260 }],
  three: [
    { x: 300, y: 260 },
    { x: 460, y: 260 },
    { x: 620, y: 260 }
  ],
  celtic: [
    { x: 420, y: 260 },
    { x: 420, y: 260, cross:true },
    { x: 420, y: 500 },
    { x: 260, y: 260 },
    { x: 420, y: 40 },
    { x: 580, y: 260 },
    { x: 700, y: 400 },
    { x: 700, y: 300 },
    { x: 700, y: 180 },
    { x: 700, y: 80 }
  ]
};

// ===== Create card =====
function createCard(img, rotate=false) {
  const card = document.createElement("div");
  card.className = "card";
  if(rotate) card.style.transform = "rotate(90deg)";

  card.addEventListener("click", () => {
    if(!card.classList.contains("flipped")) card.classList.add("flipped");
    card.style.zIndex = ++topZ;
    meaningPanel.style.display = "block";

    const imgPath = card.querySelector(".front").style.backgroundImage;
    const match = imgPath.match(/\/([^\/]+)\.jpg/);
    if(!match) return;
    const cardID = match[1];
    const info = cardMeanings[cardID];
    if(!info) return;

    const question = document.getElementById("userQuestion").value;

    // Placement note
    const allCards = [...container.querySelectorAll(".card")];
    const cardIndex = allCards.indexOf(card);
    let note = "";
    if(currentSpread && placementNotes[currentSpread])
      note = placementNotes[currentSpread][cardIndex] || "";

    meaningPanel.innerHTML = `
      <strong>${info.name}</strong><br>
      <em>Question:</em> ${question || "(No question entered)"}<br>
      ${info.upright || ""}<br>
      ${note ? `<em>Placement note:</em> ${note}` : ""}
    `;
  });

  const inner = document.createElement("div");
  inner.className = "card-inner";
  inner.innerHTML = `
    <div class="face" style="background-image:url(cards/back.jpg)"></div>
    <div class="face front" style="background-image:url(${img})"></div>
  `;
  card.appendChild(inner);
  return card;
}

// ===== Deal spread =====
function deal(type) {
  container.querySelectorAll(".card").forEach(c=>c.remove());
  meaningPanel.style.display = "none";

  currentSpread = type;
  clarifyIndex = spreads[type].length;
  topZ = 100;

  workingDeck = shuffle(deck);
  leftEdge = Infinity;

  spreads[type].forEach((pos, i)=>{
    const card = createCard(workingDeck[i].img, pos.cross);
    card.style.left = pos.x+"px";
    card.style.top = pos.y+"px";
    card.style.zIndex = ++topZ;
    container.appendChild(card);
    leftEdge = Math.min(leftEdge, pos.x);
  });
}

// ===== Reshuffle =====
function reshuffle() {
  if(currentSpread) deal(currentSpread);
}

// ===== All flipped check =====
function allCardsFlipped() {
  return [...container.querySelectorAll(".card")]
    .every(card => card.classList.contains("flipped"));
}

// ===== Clarify card =====
function clarify() {
  if(!currentSpread || !allCardsFlipped() || clarifyIndex >= workingDeck.length) return;

  const card = createCard(workingDeck[clarifyIndex].img);
  const index = clarifyIndex - spreads[currentSpread].length;
  const offset = Math.min(index, 5);

  card.style.left = (leftEdge - 180 - offset*30)+"px";
  card.style.top = "260px";
  card.style.zIndex = ++topZ;

  container.appendChild(card);
  clarifyIndex++;
}

// ===== Full deck =====
const deck = [
  // Major Arcana
  ...[
    "00_Fool","01_Magician","02_High_Priestess","03_Empress","04_Emperor",
    "05_Hierophant","06_Lovers","07_Chariot","08_Strength","09_Hermit",
    "10_Wheel","11_Justice","12_Hanged_Man","13_Death","14_Temperance",
    "15_Devil","16_Tower","17_Star","18_Moon","19_Sun",
    "20_Judgement","21_World"
  ].map(n=>({img:`cards/major/${n}.jpg`})),

  // Minor Arcana
  ...Array.from({length:14},(_,i)=>({img:`cards/cups/Cups${String(i+1).padStart(2,"0")}.jpg`})),
  ...Array.from({length:14},(_,i)=>({img:`cards/swords/Swords${String(i+1).padStart(2,"0")}.jpg`})),
  ...Array.from({length:14},(_,i)=>({img:`cards/pents/Pents${String(i+1).padStart(2,"0")}.jpg`})),
  ...Array.from({length:14},(_,i)=>({img:`cards/wands/Wands${String(i+1).padStart(2,"0")}.jpg`}))
];
</script>

</body>
</html>
