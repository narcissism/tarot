<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tarot</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: #111;
  color: #eee;
  font-family: serif;
  display: flex;
}

#controls {
  width: 220px;
  padding: 20px;
  background: #222;
  border-right: 1px solid #444;
  z-index: 10;
}

button {
  width: 100%;
  margin-bottom: 12px;
  padding: 10px;
  background: #333;
  color: #eee;
  border: 1px solid #555;
  border-radius: 6px;
  cursor: pointer;
}

button:hover { background: #444; }

#fan-container {
  flex: 1;
  position: relative;
  overflow: hidden;
}

/* ===== CARD ===== */

.card {
  position: absolute;
  width: 140px;
  height: 220px;
  perspective: 1000px;
  cursor: pointer;
}

.card-inner {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.7s ease;
}

.card.flipped .card-inner {
  transform: rotateY(180deg);
  pointer-events: none;
}

.face {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  background-size: cover;
  background-position: center;
  border-radius: 10px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.7);
}

.front {
  transform: rotateY(180deg);
}
</style>
</head>

<body>

<div id="controls">
  <button onclick="deal('single')">Single Card</button>
  <button onclick="deal('three')">Past · Present · Future</button>
  <button onclick="deal('celtic')">Celtic Cross</button>
  <button onclick="reshuffle()">Reshuffle</button>
  <button onclick="clarify()">Clarify</button>
</div>

<div id="fan-container"></div>

<audio id="shuffleSound" src="sounds/shuffle.mp3" preload="auto"></audio>
<audio id="flipSound" src="sounds/flip.mp3" preload="auto"></audio>

<script>
const container = document.getElementById("fan-container");
const shuffleSound = document.getElementById("shuffleSound");
const flipSound = document.getElementById("flipSound");
const CARD_BACK = "cards/back.jpg";

let workingDeck = [];
let clarifyIndex = 0;
let lastSpreadRightEdge = 0;
let currentSpread = null;
let audioUnlocked = false;

/* ===== AUDIO UNLOCK ===== */
function unlockAudio() {
  if (audioUnlocked) return;
  shuffleSound.play().catch(()=>{});
  shuffleSound.pause();
  flipSound.play().catch(()=>{});
  flipSound.pause();
  audioUnlocked = true;
}

function play(sound) {
  unlockAudio();
  sound.currentTime = 0;
  sound.volume = 0.4;
  sound.play().catch(()=>{});
}

/* ===== SHUFFLE ===== */
function shuffle(arr) {
  return [...arr].sort(() => Math.random() - 0.5);
}

/* ===== SPREAD POSITIONS ===== */

const spreads = {
  single: [
    { x: 420, y: 260 }
  ],

  three: [
    { x: 260, y: 260 },
    { x: 420, y: 260 },
    { x: 580, y: 260 }
  ],

  celtic: [
    { x: 420, y: 260 }, // 1 center
    { x: 420, y: 290, cross: true }, // 2 horizontal crossing
    { x: 420, y: 500 }, // 3 below
    { x: 260, y: 260 }, // 4 left
    { x: 420, y: 40  }, // 5 above
    { x: 580, y: 260 }, // 6 right

    // Staff (fully visible, no overlap)
    { x: 760, y: 420 }, // 7
    { x: 760, y: 300 }, // 8
    { x: 760, y: 180 }, // 9
    { x: 760, y: 60  }  // 10
  ]
};

/* ===== CARD CREATION ===== */

function createCard(img, z, rotate=false) {
  const card = document.createElement("div");
  card.className = "card";
  card.style.zIndex = z;

  if (rotate) {
    card.style.transform = "rotate(90deg)";
  }

  const inner = document.createElement("div");
  inner.className = "card-inner";

  const back = document.createElement("div");
  back.className = "face";
  back.style.backgroundImage = `url(${CARD_BACK})`;

  const front = document.createElement("div");
  front.className = "face front";
  front.style.backgroundImage = `url(${img})`;

  card.addEventListener("click", () => {
    if (!card.classList.contains("flipped")) {
      play(flipSound);
      card.classList.add("flipped");
    }
  });

  inner.append(back, front);
  card.appendChild(inner);
  return card;
}

/* ===== DEAL ===== */

function deal(type) {
  unlockAudio();
  container.innerHTML = "";
  play(shuffleSound);

  currentSpread = type;
  workingDeck = shuffle(deck);
  clarifyIndex = spreads[type].length;
  lastSpreadRightEdge = 0;

  spreads[type].forEach((pos, i) => {
    const isCross = pos.cross === true;
    const card = createCard(
      workingDeck[i].img,
      isCross ? 3 : i === 0 ? 2 : 1,
      isCross
    );

    card.style.left = pos.x + "px";
    card.style.top = pos.y + "px";

    container.appendChild(card);
    lastSpreadRightEdge = Math.max(lastSpreadRightEdge, pos.x);
  });
}

/* ===== RESHUFFLE ===== */

function reshuffle() {
  if (!currentSpread) return;
  deal(currentSpread);
}

/* ===== CLARIFY ===== */

function clarify() {
  if (!workingDeck.length || clarifyIndex >= workingDeck.length) return;

  const x = lastSpreadRightEdge + 180 + (clarifyIndex * 6);
  const y = 260;

  const card = createCard(
    workingDeck[clarifyIndex].img,
    clarifyIndex + 10
  );

  card.style.left = x + "px";
  card.style.top = y + "px";

  container.appendChild(card);
  clarifyIndex++;
}

/* ===== FULL 78 CARD DECK ===== */

const deck = [
  { img: "cards/major/00_Fool.jpg" },
  { img: "cards/major/01_Magician.jpg" },
  { img: "cards/major/02_High_Priestess.jpg" },
  { img: "cards/major/03_Empress.jpg" },
  { img: "cards/major/04_Emperor.jpg" },
  { img: "cards/major/05_Hierophant.jpg" },
  { img: "cards/major/06_Lovers.jpg" },
  { img: "cards/major/07_Chariot.jpg" },
  { img: "cards/major/08_Strength.jpg" },
  { img: "cards/major/09_Hermit.jpg" },
  { img: "cards/major/10_Wheel.jpg" },
  { img: "cards/major/11_Justice.jpg" },
  { img: "cards/major/12_Hanged_Man.jpg" },
  { img: "cards/major/13_Death.jpg" },
  { img: "cards/major/14_Temperance.jpg" },
  { img: "cards/major/15_Devil.jpg" },
  { img: "cards/major/16_Tower.jpg" },
  { img: "cards/major/17_Star.jpg" },
  { img: "cards/major/18_Moon.jpg" },
  { img: "cards/major/19_Sun.jpg" },
  { img: "cards/major/20_Judgement.jpg" },
  { img: "cards/major/21_World.jpg" },

  ...Array.from({ length: 14 }, (_, i) => ({ img: `cards/cups/Cups${String(i+1).padStart(2,"0")}.jpg` })),
  ...Array.from({ length: 14 }, (_, i) => ({ img: `cards/swords/Swords${String(i+1).padStart(2,"0")}.jpg` })),
  ...Array.from({ length: 14 }, (_, i) => ({ img: `cards/pents/Pents${String(i+1).padStart(2,"0")}.jpg` })),
  ...Array.from({ length: 14 }, (_, i) => ({ img: `cards/wands/Wands${String(i+1).padStart(2,"0")}.jpg` }))
];
</script>

</body>
</html>
