<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tarot Reader</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: #111;
  color: #eee;
  font-family: serif;
  display: flex;
}

#controls {
  width: 220px;
  padding: 20px;
  background: #222;
  border-right: 1px solid #444;
}

button {
  width: 100%;
  margin-bottom: 12px;
  padding: 10px;
  background: #333;
  color: #eee;
  border: 1px solid #555;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background: #444; }

#fan-container {
  flex: 1;
  position: relative;
  overflow: hidden;
}

/* Meaning panel */
#meaning-panel {
  position: absolute;
  bottom: 20px;
  left: 20px;
  width: 260px;
  padding: 14px;
  background: rgba(0,0,0,0.75);
  border: 1px solid #444;
  border-radius: 8px;
  font-size: 14px;
  display: none;
}

/* Card styles */
.card {
  position: absolute;
  width: 140px;
  height: 220px;
  perspective: 1000px;
  cursor: pointer;
}

.card-inner {
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  transition: transform 0.7s ease;
  position: relative;
}

.card.flipped .card-inner {
  transform: rotateY(180deg);
}

.face {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  background-size: cover;
  background-position: center;
  border-radius: 10px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.7);
}

.front { transform: rotateY(180deg); }
</style>
</head>

<body>

<div id="controls">
  <button onclick="deal('single')">Single Card</button>
  <button onclick="deal('three')">Past · Present · Future</button>
  <button onclick="deal('celtic')">Celtic Cross</button>
  <button onclick="clarify()">Clarify</button>
  <button onclick="reshuffle()">Reshuffle</button>
</div>

<div id="fan-container">
  <div id="meaning-panel">Card meanings will appear here.</div>
</div>

<audio id="shuffleSound" src="sounds/shuffle.mp3" preload="auto"></audio>
<audio id="flipSound" src="sounds/flip.mp3" preload="auto"></audio>

<script>
const container = document.getElementById("fan-container");
const meaningPanel = document.getElementById("meaning-panel");
const shuffleSound = document.getElementById("shuffleSound");
const flipSound = document.getElementById("flipSound");

let workingDeck = [];
let currentSpread = null;
let clarifyIndex = 0;
let topZ = 100;
let leftEdge = 0;

/* ===== AUDIO UNLOCK ===== */
document.addEventListener("click", () => {
  shuffleSound.muted = false;
  flipSound.muted = false;
  shuffleSound.volume = 0.4;
  flipSound.volume = 0.4;
}, { once: true });

function play(sound) {
  sound.currentTime = 0;
  sound.play().catch(()=>{});
}

/* ===== TRUE SHUFFLE ===== */
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* ===== SPREAD DEFINITIONS ===== */
const spreads = {
  single: [
    { x: 420, y: 260 }
  ],
  three: [
    { x: 300, y: 260 },
    { x: 460, y: 260 },
    { x: 620, y: 260 }
  ],
  celtic: [
    { x: 420, y: 260 },
    { x: 420, y: 260, cross:true },
    { x: 420, y: 500 },
    { x: 260, y: 260 },
    { x: 420, y: 40 },
    { x: 580, y: 260 },
    { x: 760, y: 460 },
    { x: 760, y: 320 },
    { x: 760, y: 180 },
    { x: 760, y: 40 }
  ]
};

/* ===== CARD CREATION ===== */
function createCard(img, rotate=false) {
  const card = document.createElement("div");
  card.className = "card";
  if (rotate) card.style.transform = "rotate(90deg)";

  card.addEventListener("click", () => {
    if (!card.classList.contains("flipped")) {
      play(flipSound);
      card.classList.add("flipped");
    }
    card.style.zIndex = ++topZ;
    meaningPanel.style.display = "block";
  });

  const inner = document.createElement("div");
  inner.className = "card-inner";
  inner.innerHTML = `
    <div class="face" style="background-image:url(cards/back.jpg)"></div>
    <div class="face front" style="background-image:url(${img})"></div>
  `;
  card.appendChild(inner);
  return card;
}

/* ===== DEAL ===== */
function deal(type) {
  container.querySelectorAll(".card").forEach(c => c.remove());
  meaningPanel.style.display = "none";

  currentSpread = type;
  clarifyIndex = spreads[type].length;
  topZ = 100;

  workingDeck = shuffle(deck);
  play(shuffleSound);

  leftEdge = Infinity;

  spreads[type].forEach((pos, i) => {
    const card = createCard(workingDeck[i].img, pos.cross);
    card.style.left = pos.x + "px";
    card.style.top = pos.y + "px";
    card.style.zIndex = ++topZ;
    container.appendChild(card);
    leftEdge = Math.min(leftEdge, pos.x);
  });
}

/* ===== RESHUFFLE ===== */
function reshuffle() {
  if (currentSpread) deal(currentSpread);
}

/* ===== ALL FLIPPED CHECK ===== */
function allCardsFlipped() {
  return [...container.querySelectorAll(".card")]
    .every(card => card.classList.contains("flipped"));
}

/* ===== CLARIFY ===== */
function clarify() {
  if (!currentSpread) return;
  if (!allCardsFlipped()) return;
  if (clarifyIndex >= workingDeck.length) return;

  const card = createCard(workingDeck[clarifyIndex].img);
  const index = clarifyIndex - spreads[currentSpread].length;

  const offset = Math.min(index, 5);
  card.style.left = (leftEdge - 180 - offset * 30) + "px";
  card.style.top = "260px";
  card.style.zIndex = ++topZ;

  container.appendChild(card);
  clarifyIndex++;
}

/* ===== DECK ===== */
const deck = [
  // Major Arcana (explicit filenames)
  ...[
    "00_Fool","01_Magician","02_High_Priestess","03_Empress","04_Emperor",
    "05_Hierophant","06_Lovers","07_Chariot","08_Strength","09_Hermit",
    "10_Wheel","11_Justice","12_Hanged_Man","13_Death","14_Temperance",
    "15_Devil","16_Tower","17_Star","18_Moon","19_Sun",
    "20_Judgement","21_World"
  ].map(n => ({ img: `cards/major/${n}.jpg` })),

  // Minor Arcana
  ...Array.from({length:14},(_,i)=>({ img:`cards/cups/Cups${String(i+1).padStart(2,"0")}.jpg` })),
  ...Array.from({length:14},(_,i)=>({ img:`cards/swords/Swords${String(i+1).padStart(2,"0")}.jpg` })),
  ...Array.from({length:14},(_,i)=>({ img:`cards/pents/Pents${String(i+1).padStart(2,"0")}.jpg` })),
  ...Array.from({length:14},(_,i)=>({ img:`cards/wants/Wands${String(i+1).padStart(2,"0")}.jpg` }))
];
</script>

</body>
</html>
